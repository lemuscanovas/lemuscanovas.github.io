<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Circulation-To-Environment • synoptReg</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Circulation-To-Environment">
<meta property="og:description" content="synoptReg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">synoptReg</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/circulation-to-environment.html">Circulation-To-Environment</a>
    </li>
    <li>
      <a href="../articles/classification_metrics.html">Extracting metrics from the synoptic classification</a>
    </li>
    <li>
      <a href="../articles/environment-to-circulation.html">Environment-To-Circulation</a>
    </li>
    <li>
      <a href="../articles/Lamb.html">Objective Lamb classification</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/lemuscanovas/synoptReg/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="circulation-to-environment_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Circulation-To-Environment</h1>
                        <h4 class="author">Marc Lemus-Canovas</h4>
            
            <h4 class="date">2020-12-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/lemuscanovas/synoptReg/blob/master/vignettes/circulation-to-environment.Rmd"><code>vignettes/circulation-to-environment.Rmd</code></a></small>
      <div class="hidden name"><code>circulation-to-environment.Rmd</code></div>

    </div>

    
    
<p>The <code>synoptReg</code> package contains two main methods to perform a synoptic classification based on the matrix mode. One of them is the <code>S-mode</code>.</p>
<div id="introduction-to-the-s-mode-classification-method" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction-to-the-s-mode-classification-method" class="anchor"></a>Introduction to the S-mode classification method</h1>
<p>The S-mode classification is that in which the grid points (lon-lat) are the variables and the observations (rows), the days. Thus, the application of a PCA on this type of matrix establishes the linear relationships between the time series of all the grid points. In this sense, the scores obtained in this type of classification show the degree of representativeness of each day for each of the principal components (PCs). However, the scores do not allow us to directly obtain the circulation types (also known as “weather types”), since the same day can be represented by different PCs. For example, 2018/01/23 may have a certain degree of representation in the PC1, PC3 and PC6. For this reason, we need to use the scores (degree of representation) as coordinates in the multivariate space to execute a clustering method that ends up creating groups between those days that are most similar to each other. In addition, the VARIMAX rotation is applied to the retained PCs in order to redistribute their explained variance. The variance of the PCs after being rotated will probably not follow a consecutive order. For example, the PC1 does not have to be the one that accumulates the highest explained variance. Note that this rotation is not applied in the <code><a href="../reference/pca_decision.html">pca_decision()</a></code> function.</p>
<p>In the <code>synoptReg</code> package the clustering method implemented is the one proposed by <a href="https://rmets.onlinelibrary.wiley.com/doi/abs/10.1002/joc.1103"><em>Esteban et al. (2005)</em></a>, based on the extreme scores. <em>Esteban et al.</em> suggest that the extreme scores (positive and negative) of each PC (&gt;2 or &lt;-2) can be used as the multivariate coordinates of each cluster center to apply the k-means algorithm. In this sense, when using the positive and negative scores, the groups in each component are split (if for each group these extreme scores are reached). So, if we retain 4 PCs, our final classification can have up to 8 weather types/circulation types.</p>
</div>
<div id="synoptic-classification-procedure" class="section level1">
<h1 class="hasAnchor">
<a href="#synoptic-classification-procedure" class="anchor"></a>Synoptic classification procedure</h1>
<p>In this example we will use the data previously downloaded with the <code><a href="../reference/download_ncep.html">download_ncep()</a></code> function. Specifically, we will use the <code>mslp</code> and <code>z500</code> objects loaded into the package, referring to the mean sea level pressure and 500 hPa geopotential height variables, respectively. The time period of the atmospheric variables is from 2000-01-01 to 2002-12-31. A total of 3 years.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">synoptReg</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ****</span>
<span class="co">#&gt; Welcome to synoptReg! </span>
<span class="co">#&gt; Using synoptReg for research publication?  Please cite it!</span>
<span class="co">#&gt; I'm an early career researcher and every citation matters.</span>
<span class="co">#&gt; ****</span>
<span class="co"># check ?download_ncep() to see how to download reanalysis data.</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">mslp</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">z500</span><span class="op">)</span></code></pre></div>
<p>The first step before executing the synoptic classification is to pass the function <code><a href="../reference/tidy_nc.html">tidy_nc()</a></code>, since it will allow us to join the two atmospheric variables to execute the classification later. It is also possible to subset the time period and the geographical extension. In addition, whether we specify an argument or not, this function computes the anomaly of each atmospheric variable. Such anomaly is computed with respect to the monthly average. If we subset the time period using the <code>time_subet</code> argument, the anomaly will be computed from this last period.</p>
<p>In any case, now we will only group our atmospheric variables. It is mandatory to use a <code>list</code> for grouping variables.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tidy_nc.html">tidy_nc</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">mslp</span>,<span class="va">z500</span><span class="op">)</span>, name_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mslp"</span>,<span class="st">"z500"</span><span class="op">)</span><span class="op">)</span>
<span class="va">vars</span>
<span class="co">#&gt; # A tibble: 484,432 x 6</span>
<span class="co">#&gt;    var     lon   lat time         value anom_value</span>
<span class="co">#&gt;    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;date&gt;       &lt;dbl&gt;      &lt;dbl&gt;</span>
<span class="co">#&gt;  1 mslp  -10      60 2000-01-01 100010      -1908.</span>
<span class="co">#&gt;  2 mslp   -7.5    60 2000-01-01 100292.     -1625.</span>
<span class="co">#&gt;  3 mslp   -5      60 2000-01-01 100508.     -1410.</span>
<span class="co">#&gt;  4 mslp   -2.5    60 2000-01-01 100675      -1243.</span>
<span class="co">#&gt;  5 mslp    0      60 2000-01-01 100810      -1108.</span>
<span class="co">#&gt;  6 mslp    2.5    60 2000-01-01 100915      -1003.</span>
<span class="co">#&gt;  7 mslp    5      60 2000-01-01 101000       -918.</span>
<span class="co">#&gt;  8 mslp    7.5    60 2000-01-01 101115       -803.</span>
<span class="co">#&gt;  9 mslp   10      60 2000-01-01 101260       -658.</span>
<span class="co">#&gt; 10 mslp   12.5    60 2000-01-01 101365       -553.</span>
<span class="co">#&gt; # ... with 484,422 more rows</span></code></pre></div>
<p>Once the two variables are joined in the same <code>tibble</code>, we can proceed to explore our data set to decide the number of components to retain. For such decision we will use the <code><a href="../reference/pca_decision.html">pca_decision()</a></code> function. It is important to specify a number of generous components since what we want is to know which number of components explain most of the variance in our data. Also, since we’re working with 2 variables that have different units of measurement, it’s important to normalize/standardize such variables.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pca_decision.html">pca_decision</a></span><span class="op">(</span><span class="va">vars</span>,ncomp <span class="op">=</span> <span class="fl">30</span>,norm <span class="op">=</span> <span class="cn">T</span>,matrix_mode <span class="op">=</span> <span class="st">"S-mode"</span><span class="op">)</span>
<span class="va">info</span><span class="op">$</span><span class="va">screeplot</span> <span class="co">#scree test</span></code></pre></div>
<p><img src="circulation-to-environment_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">info</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span>,<span class="fl">10</span><span class="op">]</span> <span class="co"># first 10 PCs</span>
<span class="co">#&gt; [1] 2.092658247 0.009916782 0.935191490</span></code></pre></div>
<p>After taking a look at the scree test, it seems reasonable to retain 4 PCs, which will be, probably, 8 WT. These 4 PCs explain 82% of the variance explained. Now, we can already compute the synoptic classification:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/synoptclas.html">synoptclas</a></span><span class="op">(</span><span class="va">vars</span>,ncomp <span class="op">=</span> <span class="fl">4</span>,norm <span class="op">=</span> <span class="cn">T</span>,matrix_mode <span class="op">=</span> <span class="st">"S-mode"</span><span class="op">)</span>
<span class="co">#&gt; Warning: The `x` argument of `as_tibble.matrix()` must have unique column names if `.name_repair` is omitted as of tibble 2.0.0.</span>
<span class="co">#&gt; Using compatibility `.name_repair`.</span>
<span class="co">#&gt; This warning is displayed once every 8 hours.</span>
<span class="co">#&gt; Call `lifecycle::last_warnings()` to see where this warning was generated.</span>
<span class="va">cl</span> <span class="co"># list object containing the classification and the classified grid</span>
<span class="co">#&gt; $clas</span>
<span class="co">#&gt; # A tibble: 1,096 x 2</span>
<span class="co">#&gt;    time          WT</span>
<span class="co">#&gt;    &lt;date&gt;     &lt;int&gt;</span>
<span class="co">#&gt;  1 2000-01-01     5</span>
<span class="co">#&gt;  2 2000-01-02     2</span>
<span class="co">#&gt;  3 2000-01-03     2</span>
<span class="co">#&gt;  4 2000-01-04     2</span>
<span class="co">#&gt;  5 2000-01-05     2</span>
<span class="co">#&gt;  6 2000-01-06     2</span>
<span class="co">#&gt;  7 2000-01-07     2</span>
<span class="co">#&gt;  8 2000-01-08     2</span>
<span class="co">#&gt;  9 2000-01-09     2</span>
<span class="co">#&gt; 10 2000-01-10     6</span>
<span class="co">#&gt; # ... with 1,086 more rows</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $grid_clas</span>
<span class="co">#&gt; # A tibble: 3,094 x 8</span>
<span class="co">#&gt;    var     lon   lat time          WT mean_WT_value mean_WT_anom_va~ cv_WT_value</span>
<span class="co">#&gt;    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;date&gt;     &lt;int&gt;         &lt;dbl&gt;            &lt;dbl&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt;  1 mslp  -10      60 2000-01-01     5       101837.             257.       1.21 </span>
<span class="co">#&gt;  2 mslp   -7.5    60 2000-01-01     5       101943.             363.       1.14 </span>
<span class="co">#&gt;  3 mslp   -5      60 2000-01-01     5       102022.             442.       1.07 </span>
<span class="co">#&gt;  4 mslp   -2.5    60 2000-01-01     5       102085.             505.       1.00 </span>
<span class="co">#&gt;  5 mslp    0      60 2000-01-01     5       102131.             551.       0.922</span>
<span class="co">#&gt;  6 mslp    2.5    60 2000-01-01     5       102147.             567.       0.847</span>
<span class="co">#&gt;  7 mslp    5      60 2000-01-01     5       102142.             562.       0.791</span>
<span class="co">#&gt;  8 mslp    7.5    60 2000-01-01     5       102155.             575.       0.774</span>
<span class="co">#&gt;  9 mslp   10      60 2000-01-01     5       102149.             569.       0.788</span>
<span class="co">#&gt; 10 mslp   12.5    60 2000-01-01     5       102048.             468.       0.801</span>
<span class="co">#&gt; # ... with 3,084 more rows</span></code></pre></div>
<p>The object returned by synoptclas is a <code>list</code> that contains a <code>tibble</code> with each date and its corresponding WT, and another <code>tibble</code> that is a grid with the average value of the atmospheric variables for each CT. With this last result we can create a visualization of these synoptic patterns:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span> 
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ropenscilabs/rnaturalearth">rnaturalearth</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eliocamp/metR">metR</a></span><span class="op">)</span>
<span class="co">#&gt; Warning: package 'metR' was built under R version 4.0.3</span>

<span class="va">borders</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rnaturalearth/man/ne_countries.html">ne_countries</a></span><span class="op">(</span>continent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"europe"</span>,<span class="st">"africa"</span><span class="op">)</span>,
                                       returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_raster</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="va">grid_clas</span>, <span class="va">var</span> <span class="op">==</span> <span class="st">"z500"</span><span class="op">)</span>, 
              mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">lon</span>,<span class="va">lat</span>,fill <span class="op">=</span> <span class="va">mean_WT_anom_value</span><span class="op">)</span>,
              interpolate <span class="op">=</span> <span class="cn">T</span>,hjust <span class="op">=</span> <span class="fl">0</span>,vjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">borders</span>, fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span><span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/metR/man/geom_contour2.html">geom_contour2</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="va">grid_clas</span>,<span class="va">var</span> <span class="op">==</span> <span class="st">"mslp"</span><span class="op">)</span>,
                  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">lon</span>,y<span class="op">=</span><span class="va">lat</span>,z<span class="op">=</span><span class="va">mean_WT_value</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span>,
                  binwidth <span class="op">=</span> <span class="fl">4</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/metR/man/geom_text_contour.html">geom_text_contour</a></span><span class="op">(</span>data<span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="va">grid_clas</span>, <span class="va">var</span> <span class="op">==</span> <span class="st">"mslp"</span><span class="op">)</span>,
                      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">lon</span>,y<span class="op">=</span><span class="va">lat</span>,z<span class="op">=</span><span class="va">mean_WT_value</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span>, 
                      stroke <span class="op">=</span> <span class="fl">0.15</span>,binwidth <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html">guide_colourbar</a></span><span class="op">(</span>barwidth <span class="op">=</span> <span class="fl">9</span>, barheight <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">WT</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/metR/man/scale_divergent.html">scale_fill_divergent</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Z anomaly (m)"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>,<span class="fl">30</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">30</span>,<span class="fl">60</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
                       axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
                       axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
                       legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 203 rows containing missing values (geom_raster).</span></code></pre></div>
<p><img src="circulation-to-environment_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
</div>
<div id="from-circulation-types-to-environment" class="section level1">
<h1 class="hasAnchor">
<a href="#from-circulation-types-to-environment" class="anchor"></a>From circulation types to environment</h1>
<p><code>synoptReg</code> has a function called <code><a href="../reference/ct2env.html">ct2env()</a></code> that allows to estalblish the link between the synoptic classification created previously and its link with any environmental variable. In this case, the example uses daily precipitation data from the Balearic Islands (Spain) at a resolution of 5x5 km.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">pcp</span><span class="op">)</span>
<span class="va">pcp</span>
<span class="co">#&gt; # A tibble: 847,798 x 4</span>
<span class="co">#&gt;       lon     lat time       value</span>
<span class="co">#&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;date&gt;     &lt;int&gt;</span>
<span class="co">#&gt;  1 865672 4313822 2000-01-01     0</span>
<span class="co">#&gt;  2 870672 4313822 2000-01-01     0</span>
<span class="co">#&gt;  3 870672 4318822 2000-01-01     0</span>
<span class="co">#&gt;  4 875672 4313822 2000-01-01     0</span>
<span class="co">#&gt;  5 875672 4318822 2000-01-01     0</span>
<span class="co">#&gt;  6 875672 4323822 2000-01-01     0</span>
<span class="co">#&gt;  7 875672 4328822 2000-01-01     0</span>
<span class="co">#&gt;  8 880672 4308822 2000-01-01     0</span>
<span class="co">#&gt;  9 880672 4313822 2000-01-01     0</span>
<span class="co">#&gt; 10 880672 4318822 2000-01-01     0</span>
<span class="co">#&gt; # ... with 847,788 more rows</span></code></pre></div>
<p>As you can observe, the structure of the <code>tibble</code> is always the same (variables: <code>lon</code>, <code>lat</code>, <code>time</code>, <code>value</code>) and has to be respected so that all the functions of the package work correctly. How do we calculate the interaction of WTs with precipitation?</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ct2pcp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ct2env.html">ct2env</a></span><span class="op">(</span><span class="va">pcp</span>,clas <span class="op">=</span> <span class="va">cl</span><span class="op">$</span><span class="va">clas</span>,fun <span class="op">=</span> <span class="va">mean</span>,out <span class="op">=</span> <span class="st">"data.frame"</span><span class="op">)</span>
<span class="va">ct2pcp</span>
<span class="co">#&gt; # A tibble: 1,477 x 4</span>
<span class="co">#&gt;       lon     lat    WT  calc</span>
<span class="co">#&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1 865672 4313822     5  30.7</span>
<span class="co">#&gt;  2 870672 4313822     5  25.4</span>
<span class="co">#&gt;  3 870672 4318822     5  25.5</span>
<span class="co">#&gt;  4 875672 4313822     5  19.1</span>
<span class="co">#&gt;  5 875672 4318822     5  18.7</span>
<span class="co">#&gt;  6 875672 4323822     5  22.5</span>
<span class="co">#&gt;  7 875672 4328822     5  22.3</span>
<span class="co">#&gt;  8 880672 4308822     5  16.2</span>
<span class="co">#&gt;  9 880672 4313822     5  16.8</span>
<span class="co">#&gt; 10 880672 4318822     5  18.0</span>
<span class="co">#&gt; # ... with 1,467 more rows</span></code></pre></div>
<p>The result is a <code>tibble</code> containing the variables <code>lon</code>, <code>lat</code>, <code>WT</code> and <code>calc</code>. This last column is the result of the average precipitation for each grid point and WT.</p>
<p>To visualize the result:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">ct2pcp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">lon</span>, y<span class="op">=</span><span class="va">lat</span>,fill<span class="op">=</span><span class="va">calc</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># original was mm*10</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span>colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fu">pals</span><span class="fu">::</span><span class="fu"><a href="http://kwstat.github.io/pals/reference/niccoli.html">linearl</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>, 
  name <span class="op">=</span> <span class="st">"rainfall (mm)"</span>,na.value<span class="op">=</span><span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_colour_gradient</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">WT</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html">guide_colourbar</a></span><span class="op">(</span>barwidth <span class="op">=</span> <span class="fl">9</span>, barheight <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, 
                     axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
                     axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
                     legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<p><img src="circulation-to-environment_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
</div>
<div id="creating-categorized-regions--the-last-step-" class="section level1">
<h1 class="hasAnchor">
<a href="#creating-categorized-regions--the-last-step-" class="anchor"></a>Creating categorized regions. The last step.</h1>
<p>Finally, it may be interesting to classify our environmental variables into different regions. Each one of these regions will have different characteristics based on the relation with the precipitation linked to each WT. To carry out such a categorization process, it is necessary that our object <code>ct2pcp</code> is in <code>raster</code> format:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ct2pcp_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ct2env.html">ct2env</a></span><span class="op">(</span><span class="va">pcp</span>,clas <span class="op">=</span> <span class="va">cl</span><span class="op">$</span><span class="va">clas</span>,fun <span class="op">=</span> <span class="va">mean</span>,out <span class="op">=</span> <span class="st">"raster"</span><span class="op">)</span>
<span class="co">#&gt; Warning in matrix(values, nrow = ncell(x), ncol = nlayers(x)): la longitud de</span>
<span class="co">#&gt; los datos [12939] no es un submúltiplo o múltiplo del número de filas [1855] en</span>
<span class="co">#&gt; la matriz</span>
<span class="va">ct2pcp_r</span>
<span class="co">#&gt; class      : RasterBrick </span>
<span class="co">#&gt; dimensions : 35, 53, 1855, 7  (nrow, ncol, ncell, nlayers)</span>
<span class="co">#&gt; resolution : 5000, 5000  (x, y)</span>
<span class="co">#&gt; extent     : 863172, 1128172, 4286322, 4461322  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; crs        : NA </span>
<span class="co">#&gt; source     : memory</span>
<span class="co">#&gt; names      :         X1,         X2,         X3,         X4,         X5,         X6,         X7 </span>
<span class="co">#&gt; min values :  3.8611111,  0.6782609, 17.0173913,  4.9358974,  6.4693878, 15.1602210,  4.1316726 </span>
<span class="co">#&gt; max values :   42.43056,   21.13913,   76.66087,   31.19231,   46.71429,  111.12707,   20.75445</span></code></pre></div>
<p>Now it is a matter of extracting the main spatial patterns of precipitation linked to WTs. For this purpose, we will use the <code><a href="../reference/raster_pca.html">raster_pca()</a></code> function.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ct2pcp_r_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/raster_pca.html">raster_pca</a></span><span class="op">(</span><span class="va">ct2pcp_r</span><span class="op">)</span>
<span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">ct2pcp_r_pca</span><span class="op">$</span><span class="va">rasterPCA</span><span class="op">)</span></code></pre></div>
<p><img src="circulation-to-environment_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ct2pcp_r_pca</span><span class="op">$</span><span class="va">summary</span>
<span class="co">#&gt;                  Comp.1    Comp.2     Comp.3     Comp.4     Comp.5     Comp.6</span>
<span class="co">#&gt; sdev          2.2273443 0.8918598 0.70747960 0.56361656 0.45290397 0.36876672</span>
<span class="co">#&gt; prop.variance 0.7087232 0.1136306 0.07150391 0.04538052 0.02930314 0.01942698</span>
<span class="co">#&gt; cum.variance  0.7087232 0.8223538 0.89385770 0.93923821 0.96854136 0.98796834</span>
<span class="co">#&gt;                   Comp.7</span>
<span class="co">#&gt; sdev          0.29020957</span>
<span class="co">#&gt; prop.variance 0.01203166</span>
<span class="co">#&gt; cum.variance  1.00000000</span></code></pre></div>
<p>The first 4 PCs accumulate almost 95% of the variance of our original data. Thus, we will use these 4 PCs to run our regionalization by means of the K-means algorithm implemented in the <code><a href="../reference/regionalization.html">regionalization()</a></code> function. For more details on how the regionalization is performed, please read <a href="https://www.sciencedirect.com/science/article/pii/S016980951831189X"><em>Lemus-Canovas et al. (2019)</em></a></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Regionalization</span>
<span class="va">ct2pcp_reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/regionalization.html">regionalization</a></span><span class="op">(</span><span class="va">ct2pcp_r_pca</span><span class="op">$</span><span class="va">rasterPCA</span><span class="op">[[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>,centers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> 

<span class="va">precp_region_df</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">ct2pcp_reg</span><span class="op">$</span><span class="va">regionalization</span>, 
                                 xy <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="co"># Visualization:</span>

<span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Region 1"</span>,<span class="st">"Region 2"</span>,
           <span class="st">"Region 3"</span>, <span class="st">"Region 4"</span><span class="op">)</span>
<span class="va">colours</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mediumseagreen"</span>,<span class="st">"darkgoldenrod1"</span>,
              <span class="st">"khaki1"</span>, <span class="st">"dodgerblue3"</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">precp_region_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span>,fill<span class="op">=</span><span class="va">layer</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span>colours <span class="op">=</span> <span class="va">colours</span>,
                       guide <span class="op">=</span> <span class="st">"legend"</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span>,
                       na.value <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org//reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.0</span><span class="op">)</span>,
                       labels <span class="op">=</span> <span class="va">labels</span>, name<span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        legend.position <span class="op">=</span> <span class="st">"bottom"</span>, axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="circulation-to-environment_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>To be more accurate, we should execute an iterative process with the function <code><a href="../reference/regionalization.html">regionalization()</a></code> to evaluate the clustering error using the metric <code>pseudoMAE</code> included in the outputs of this function.</p>
</div>
<div id="method-references" class="section level1">
<h1 class="hasAnchor">
<a href="#method-references" class="anchor"></a>Method references</h1>
<p><strong>Synoptic classification method</strong>:</p>
<ul>
<li>Esteban, P., Jones, P.D., Martín-Vide, J., Mases, M., 2005. Atmospheric circulation patterns related to heavy snowfall days in Andorra, Pyrenees. Int. J. Climatol. 25, 319–329. <a href="https://doi.org/10.1002/joc.1103" class="uri">https://doi.org/10.1002/joc.1103</a>
</li>
</ul>
<p><strong>Clustering method using the precipitation patterns linked to the weather types</strong>:</p>
<ul>
<li><p>Lemus-Canovas, M., Lopez-Bustins, J.A., Trapero, L., Martin-Vide, J., 2019. Combining circulation weather types and daily precipitation modelling to derive climatic precipitation regions in the Pyrenees. Atmos. Res. 220, 181–193. <a href="https://doi.org/10.1016/J.ATMOSRES.2019.01.018" class="uri">https://doi.org/10.1016/J.ATMOSRES.2019.01.018</a></p></li>
<li><p>Lemus-Canovas, M., Lopez-Bustins, J.A., Martin-Vide, J., Royé, D., 2019. synoptReg: An R package for computing a synoptic climate classification and a spatial regionalization of environmental data. Environ. Model. Softw. 118, 114–119. <a href="https://doi.org/10.1016/J.ENVSOFT.2019.04.006" class="uri">https://doi.org/10.1016/J.ENVSOFT.2019.04.006</a></p></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Marc Lemus-Canovas, Dominic Roye).</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
